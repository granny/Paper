From 8970c8040a87bb9da1d22cabfd5dafb79924ed1f Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/level/block/ConcretePowderBlock.java b/net/minecraft/world/level/block/ConcretePowderBlock.java
index e6ee06ad5d609045b808ef720ba27b0d22d807b9..0ef3fd28a7182dd1b6bca94c7e4bb44f1775eb5d 100644
--- a/net/minecraft/world/level/block/ConcretePowderBlock.java
+++ b/net/minecraft/world/level/block/ConcretePowderBlock.java
@@ -38,16 +38,31 @@ public class ConcretePowderBlock extends FallingBlock {
     @Override
     public void onLand(Level level, BlockPos pos, BlockState state, BlockState replaceableState, FallingBlockEntity fallingBlock) {
         if (shouldSolidify(level, pos, replaceableState)) {
-            level.setBlock(pos, this.concrete.defaultBlockState(), 3);
+            org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockFormEvent(level, pos, this.concrete.defaultBlockState(), 3); // CraftBukkit
         }
     }
 
     @Override
     public BlockState getStateForPlacement(BlockPlaceContext context) {
-        BlockGetter level = context.getLevel();
+        Level level = context.getLevel(); // Paper
         BlockPos clickedPos = context.getClickedPos();
         BlockState blockState = level.getBlockState(clickedPos);
-        return shouldSolidify(level, clickedPos, blockState) ? this.concrete.defaultBlockState() : super.getStateForPlacement(context);
+        // CraftBukkit start
+        if (!ConcretePowderBlock.shouldSolidify(level, clickedPos, blockState)) {
+            return super.getStateForPlacement(context);
+        }
+
+        // TODO: An event factory call for methods like this
+        org.bukkit.craftbukkit.block.state.CraftBlockState craftBlockState = org.bukkit.craftbukkit.block.state.CraftBlockStates.getBlockState(level, clickedPos);
+        craftBlockState.setData(this.concrete.defaultBlockState());
+
+        org.bukkit.event.block.BlockFormEvent event = new org.bukkit.event.block.BlockFormEvent(craftBlockState.getBlock(), craftBlockState);
+        if (event.callEvent()) {
+            return craftBlockState.getHandle();
+        }
+
+        return super.getStateForPlacement(context);
+        // CraftBukkit end
     }
 
     private static boolean shouldSolidify(BlockGetter level, BlockPos pos, BlockState state) {
@@ -88,9 +103,23 @@ public class ConcretePowderBlock extends FallingBlock {
         BlockState neighborState,
         RandomSource random
     ) {
-        return touchesLiquid(level, pos)
-            ? this.concrete.defaultBlockState()
-            : super.updateShape(state, level, scheduledTickAccess, pos, direction, neighborPos, neighborState, random);
+        // CraftBukkit start
+        if (ConcretePowderBlock.touchesLiquid(level, pos)) {
+            // Suppress during worldgen
+            if (!(level instanceof Level world1)) {
+                return this.concrete.defaultBlockState();
+            }
+            org.bukkit.craftbukkit.block.state.CraftBlockState blockState = org.bukkit.craftbukkit.block.state.CraftBlockStates.getBlockState(world1, pos);
+            blockState.setData(this.concrete.defaultBlockState());
+
+            org.bukkit.event.block.BlockFormEvent event = new org.bukkit.event.block.BlockFormEvent(blockState.getBlock(), blockState);
+            if (event.callEvent()) {
+                return blockState.getHandle();
+            }
+        }
+
+        return super.updateShape(state, level, scheduledTickAccess, pos, direction, neighborPos, neighborState, random);
+        // CraftBukkit end
     }
 
     @Override
