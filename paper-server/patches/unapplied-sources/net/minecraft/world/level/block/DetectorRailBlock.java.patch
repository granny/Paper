From 8970c8040a87bb9da1d22cabfd5dafb79924ed1f Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/level/block/DetectorRailBlock.java b/net/minecraft/world/level/block/DetectorRailBlock.java
index 3248ab77d250db13060aca0ca1f4c204ba2dfca3..3022ddd38ac5d7ab17ad38dee2e69d3684ba45ca 100644
--- a/net/minecraft/world/level/block/DetectorRailBlock.java
+++ b/net/minecraft/world/level/block/DetectorRailBlock.java
@@ -49,6 +49,7 @@ public class DetectorRailBlock extends BaseRailBlock {
 
     @Override
     protected void entityInside(BlockState state, Level level, BlockPos pos, Entity entity, InsideBlockEffectApplier effectApplier) {
+        if (!new io.papermc.paper.event.entity.EntityInsideBlockEvent(entity.getBukkitEntity(), org.bukkit.craftbukkit.block.CraftBlock.at(level, pos)).callEvent()) { return; } // Paper - Add EntityInsideBlockEvent
         if (!level.isClientSide) {
             if (!state.getValue(POWERED)) {
                 this.checkPressed(level, pos, state);
@@ -79,6 +80,7 @@ public class DetectorRailBlock extends BaseRailBlock {
 
     private void checkPressed(Level level, BlockPos pos, BlockState state) {
         if (this.canSurvive(state, level, pos)) {
+            if (!state.is(this)) { return; } // Paper - Fix some rails connecting improperly
             boolean poweredValue = state.getValue(POWERED);
             boolean flag = false;
             List<AbstractMinecart> interactingMinecartOfType = this.getInteractingMinecartOfType(level, pos, AbstractMinecart.class, entity -> true);
@@ -86,6 +88,16 @@ public class DetectorRailBlock extends BaseRailBlock {
                 flag = true;
             }
 
+            // CraftBukkit start
+            if (poweredValue != flag) {
+                org.bukkit.block.Block block = org.bukkit.craftbukkit.block.CraftBlock.at(level, pos);
+
+                org.bukkit.event.block.BlockRedstoneEvent eventRedstone = new org.bukkit.event.block.BlockRedstoneEvent(block, flag ? 15 : 0, flag ? 15 : 0);
+                level.getCraftServer().getPluginManager().callEvent(eventRedstone);
+
+                flag = eventRedstone.getNewCurrent() > 0;
+            }
+            // CraftBukkit end
             if (flag && !poweredValue) {
                 BlockState blockState = state.setValue(POWERED, true);
                 level.setBlock(pos, blockState, 3);
