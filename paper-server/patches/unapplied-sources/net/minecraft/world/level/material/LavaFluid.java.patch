From 8970c8040a87bb9da1d22cabfd5dafb79924ed1f Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/level/material/LavaFluid.java b/net/minecraft/world/level/material/LavaFluid.java
index b54bd14dc2d7ab11666610409ccf6f1f54489b0c..033f252248b671e35135269dd2df6e7ca4585604 100644
--- a/net/minecraft/world/level/material/LavaFluid.java
+++ b/net/minecraft/world/level/material/LavaFluid.java
@@ -92,6 +92,13 @@ public abstract class LavaFluid extends FlowingFluid {
                         BlockState blockState = level.getBlockState(blockPos);
                         if (blockState.isAir()) {
                             if (this.hasFlammableNeighbours(level, blockPos)) {
+                                // CraftBukkit start - Prevent lava putting something on fire
+                                if (!level.getBlockState(blockPos).is(Blocks.FIRE)) {
+                                    if (org.bukkit.craftbukkit.event.CraftEventFactory.callBlockIgniteEvent(level, blockPos, pos).isCancelled()) {
+                                        continue;
+                                    }
+                                }
+                                // CraftBukkit end
                                 level.setBlockAndUpdate(blockPos, BaseFireBlock.getState(level, blockPos));
                                 return;
                             }
@@ -107,6 +114,14 @@ public abstract class LavaFluid extends FlowingFluid {
                         }
 
                         if (level.isEmptyBlock(blockPos1.above()) && this.isFlammable(level, blockPos1)) {
+                            // CraftBukkit start - Prevent lava putting something on fire
+                            BlockPos up = blockPos1.above();
+                            if (!level.getBlockState(up).is(Blocks.FIRE)) {
+                                if (org.bukkit.craftbukkit.event.CraftEventFactory.callBlockIgniteEvent(level, up, pos).isCancelled()) {
+                                    continue;
+                                }
+                            }
+                            // CraftBukkit end - Prevent lava putting something on fire
                             level.setBlockAndUpdate(blockPos1.above(), BaseFireBlock.getState(level, blockPos1));
                         }
                     }
@@ -117,8 +132,9 @@ public abstract class LavaFluid extends FlowingFluid {
 
     @Override
     protected void entityInside(Level level, BlockPos pos, Entity entity, InsideBlockEffectApplier effectApplier) {
+        BlockPos savedPos = pos.immutable(); // Paper - track lava contact
         effectApplier.apply(InsideBlockEffectType.LAVA_IGNITE);
-        effectApplier.runAfter(InsideBlockEffectType.LAVA_IGNITE, Entity::lavaHurt);
+        effectApplier.runAfter(InsideBlockEffectType.LAVA_IGNITE, ignitedEntity -> ignitedEntity.lavaHurt(savedPos)); // Paper - track lava contact
     }
 
     private boolean hasFlammableNeighbours(LevelReader level, BlockPos pos) {
@@ -206,7 +222,11 @@ public abstract class LavaFluid extends FlowingFluid {
             FluidState fluidState1 = level.getFluidState(pos);
             if (this.is(FluidTags.LAVA) && fluidState1.is(FluidTags.WATER)) {
                 if (blockState.getBlock() instanceof LiquidBlock) {
-                    level.setBlock(pos, Blocks.STONE.defaultBlockState(), 3);
+                    // CraftBukkit start
+                    if (!org.bukkit.craftbukkit.event.CraftEventFactory.handleBlockFormEvent(level.getMinecraftWorld(), pos, Blocks.STONE.defaultBlockState(), 3)) {
+                        return;
+                    }
+                    // CraftBukkit end
                 }
 
                 this.fizz(level, pos);
@@ -224,7 +244,7 @@ public abstract class LavaFluid extends FlowingFluid {
 
     @Override
     protected float getExplosionResistance() {
-        return 100.0F;
+        return Blocks.LAVA.getExplosionResistance(); // Paper - Get explosion resistance from actual block
     }
 
     @Override
