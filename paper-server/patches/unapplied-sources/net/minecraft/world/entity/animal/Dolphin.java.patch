From 8970c8040a87bb9da1d22cabfd5dafb79924ed1f Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/entity/animal/Dolphin.java b/net/minecraft/world/entity/animal/Dolphin.java
index f9dcb33bb0bb99885a6270889707286e292227c3..8f2af65c58da50be2776a21b10db5eb9cb5f3076 100644
--- a/net/minecraft/world/entity/animal/Dolphin.java
+++ b/net/minecraft/world/entity/animal/Dolphin.java
@@ -98,6 +98,13 @@ public class Dolphin extends AgeableWaterCreature {
         return EntityType.DOLPHIN.create(level, EntitySpawnReason.BREEDING);
     }
 
+    // CraftBukkit start - SPIGOT-6907: re-implement LivingEntity#setMaximumAir()
+    @Override
+    public int getDefaultMaxAirSupply() {
+        return TOTAL_AIR_SUPPLY;
+    }
+    // CraftBukkit end
+
     @Override
     public float getAgeScale() {
         return this.isBaby() ? 0.65F : 1.0F;
@@ -182,7 +189,7 @@ public class Dolphin extends AgeableWaterCreature {
 
     @Override
     public int getMaxAirSupply() {
-        return 4800;
+        return this.maxAirTicks; // CraftBukkit - SPIGOT-6907: re-implement LivingEntity#setMaximumAir()
     }
 
     @Override
@@ -215,11 +222,15 @@ public class Dolphin extends AgeableWaterCreature {
         if (this.getItemBySlot(EquipmentSlot.MAINHAND).isEmpty()) {
             ItemStack item = entity.getItem();
             if (this.canHoldItem(item)) {
+                // CraftBukkit start - call EntityPickupItemEvent
+                if (org.bukkit.craftbukkit.event.CraftEventFactory.callEntityPickupItemEvent(this, entity, 0, false).isCancelled()) return;
+                item = entity.getItem(); // CraftBukkit- update ItemStack from event
+                // CraftBukkit end
                 this.onItemPickup(entity);
                 this.setItemSlot(EquipmentSlot.MAINHAND, item);
                 this.setGuaranteedDrop(EquipmentSlot.MAINHAND);
                 this.take(entity, item.getCount());
-                entity.discard();
+                entity.discard(org.bukkit.event.entity.EntityRemoveEvent.Cause.PICKUP); // CraftBukkit - add Bukkit remove cause
             }
         }
     }
@@ -486,7 +497,7 @@ public class Dolphin extends AgeableWaterCreature {
 
         @Override
         public void start() {
-            this.player.addEffect(new MobEffectInstance(MobEffects.DOLPHINS_GRACE, 100), this.dolphin);
+            this.player.addEffect(new MobEffectInstance(MobEffects.DOLPHINS_GRACE, 100), this.dolphin, org.bukkit.event.entity.EntityPotionEffectEvent.Cause.DOLPHIN); // CraftBukkit
         }
 
         @Override
@@ -505,7 +516,7 @@ public class Dolphin extends AgeableWaterCreature {
             }
 
             if (this.player.isSwimming() && this.player.level().random.nextInt(6) == 0) {
-                this.player.addEffect(new MobEffectInstance(MobEffects.DOLPHINS_GRACE, 100), this.dolphin);
+                this.player.addEffect(new MobEffectInstance(MobEffects.DOLPHINS_GRACE, 100), this.dolphin, org.bukkit.event.entity.EntityPotionEffectEvent.Cause.DOLPHIN); // CraftBukkit
             }
         }
     }
@@ -575,7 +586,7 @@ public class Dolphin extends AgeableWaterCreature {
                     0.3F * Mth.cos(Dolphin.this.getYRot() * (float) (Math.PI / 180.0)) * Mth.cos(Dolphin.this.getXRot() * (float) (Math.PI / 180.0))
                         + Mth.sin(f1) * f2
                 );
-                Dolphin.this.level().addFreshEntity(itemEntity);
+                Dolphin.this.spawnAtLocation(getServerLevel(Dolphin.this), itemEntity); // Paper - Call EntityDropItemEvent
             }
         }
     }
