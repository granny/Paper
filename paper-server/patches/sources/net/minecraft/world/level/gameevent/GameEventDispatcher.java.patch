From 8970c8040a87bb9da1d22cabfd5dafb79924ed1f Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/level/gameevent/GameEventDispatcher.java b/net/minecraft/world/level/gameevent/GameEventDispatcher.java
index dfce686b7cf97432be42a5918df4beb430701c3f..b06ded98c01cd2a71d52b96070a6b23da1e40f9c 100644
--- a/net/minecraft/world/level/gameevent/GameEventDispatcher.java
+++ b/net/minecraft/world/level/gameevent/GameEventDispatcher.java
@@ -21,6 +21,15 @@ public class GameEventDispatcher {
     public void post(Holder<GameEvent> gameEvent, Vec3 pos, GameEvent.Context context) {
         int notificationRadius = gameEvent.value().notificationRadius();
         BlockPos blockPos = BlockPos.containing(pos);
+        // CraftBukkit start
+        org.bukkit.event.world.GenericGameEvent apiEvent = new org.bukkit.event.world.GenericGameEvent(
+            org.bukkit.craftbukkit.CraftGameEvent.minecraftToBukkit(gameEvent.value()), org.bukkit.craftbukkit.util.CraftLocation.toBukkit(blockPos, this.level.getWorld()),
+            (context.sourceEntity() == null) ? null : context.sourceEntity().getBukkitEntity(), notificationRadius, !org.bukkit.Bukkit.isPrimaryThread());
+        if (!apiEvent.callEvent()) {
+            return;
+        }
+        notificationRadius = apiEvent.getRadius();
+        // CraftBukkit end
         int sectionPosCoord = SectionPos.blockToSectionCoord(blockPos.getX() - notificationRadius);
         int sectionPosCoord1 = SectionPos.blockToSectionCoord(blockPos.getY() - notificationRadius);
         int sectionPosCoord2 = SectionPos.blockToSectionCoord(blockPos.getZ() - notificationRadius);
@@ -39,7 +48,7 @@ public class GameEventDispatcher {
 
         for (int i = sectionPosCoord; i <= sectionPosCoord3; i++) {
             for (int i1 = sectionPosCoord2; i1 <= sectionPosCoord5; i1++) {
-                ChunkAccess chunkNow = this.level.getChunkSource().getChunkNow(i, i1);
+                ChunkAccess chunkNow = this.level.getChunkIfLoadedImmediately(i, i1); // Paper - Use getChunkIfLoadedImmediately
                 if (chunkNow != null) {
                     for (int i2 = sectionPosCoord1; i2 <= sectionPosCoord4; i2++) {
                         flag |= chunkNow.getListenerRegistry(i2).visitInRangeListeners(gameEvent, pos, context, listenerVisitor);
