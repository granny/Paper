From 8970c8040a87bb9da1d22cabfd5dafb79924ed1f Mon Sep 17 00:00:00 2001
From: File <noreply+automated@papermc.io>
Date: Sun, 20 Apr 1997 06:37:42 -0700
Subject: [PATCH] paper File Patches


diff --git a/net/minecraft/world/level/block/entity/BellBlockEntity.java b/net/minecraft/world/level/block/entity/BellBlockEntity.java
index 7b2c4fbd8f6b0c7e6e5451fdfd1eeae9404b0e4a..ff63952c10d4642d5c14f470a18bea3066aa7ab0 100644
--- a/net/minecraft/world/level/block/entity/BellBlockEntity.java
+++ b/net/minecraft/world/level/block/entity/BellBlockEntity.java
@@ -60,6 +60,11 @@ public class BellBlockEntity extends BlockEntity {
 
         if (blockEntity.ticks >= 50) {
             blockEntity.shaking = false;
+            // Paper start - Fix bell block entity memory leak
+            if (!blockEntity.resonating) {
+                blockEntity.nearbyEntities.clear();
+            }
+            // Paper end - Fix bell block entity memory leak
             blockEntity.ticks = 0;
         }
 
@@ -73,6 +78,7 @@ public class BellBlockEntity extends BlockEntity {
                 blockEntity.resonationTicks++;
             } else {
                 resonationEndAction.run(level, pos, blockEntity.nearbyEntities);
+                blockEntity.nearbyEntities.clear(); // Paper - Fix bell block entity memory leak
                 blockEntity.resonating = false;
             }
         }
@@ -113,6 +119,8 @@ public class BellBlockEntity extends BlockEntity {
                 }
             }
         }
+
+        this.nearbyEntities.removeIf(e -> !e.isAlive()); // Paper - Fix bell block entity memory leak
     }
 
     private static boolean areRaidersNearby(BlockPos pos, List<LivingEntity> raiders) {
@@ -129,7 +137,10 @@ public class BellBlockEntity extends BlockEntity {
     }
 
     private static void makeRaidersGlow(Level level, BlockPos pos, List<LivingEntity> raiders) {
-        raiders.stream().filter(raider -> isRaiderWithinRange(pos, raider)).forEach(BellBlockEntity::glow);
+        // Paper start - call bell resonate event and bell reveal raider event
+        final List<org.bukkit.entity.LivingEntity> inRangeRaiders = raiders.stream().filter(raider -> isRaiderWithinRange(pos, raider)).map(e -> (org.bukkit.entity.LivingEntity) e.getBukkitEntity()).toList();
+        org.bukkit.craftbukkit.event.CraftEventFactory.handleBellResonateEvent(level, pos, inRangeRaiders).forEach(e -> glow(e, pos));
+        // Paper end - call bell resonate event and bell reveal raider event
     }
 
     private static void showBellParticles(Level level, BlockPos pos, List<LivingEntity> raiders) {
@@ -159,7 +170,16 @@ public class BellBlockEntity extends BlockEntity {
         return raider.isAlive() && !raider.isRemoved() && pos.closerToCenterThan(raider.position(), 48.0) && raider.getType().is(EntityTypeTags.RAIDERS);
     }
 
+    @Deprecated @io.papermc.paper.annotation.DoNotUse // Paper - Add BellRevealRaiderEvent
     private static void glow(LivingEntity entity) {
+        // Paper start - Add BellRevealRaiderEvent
+        glow(entity, null);
+    }
+
+    private static void glow(LivingEntity entity, @javax.annotation.Nullable BlockPos pos) {
+        if (pos != null && !new io.papermc.paper.event.block.BellRevealRaiderEvent(org.bukkit.craftbukkit.block.CraftBlock.at(entity.level(), pos), (org.bukkit.entity.Raider) entity.getBukkitEntity()).callEvent())
+            return;
+        // Paper end - Add BellRevealRaiderEvent
         entity.addEffect(new MobEffectInstance(MobEffects.GLOWING, 60));
     }
 
